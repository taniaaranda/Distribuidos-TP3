<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Sistemas Distribuidos</title>
    <link rel="stylesheet" href="css/main.css" type="text/css">
    <!--script type="text/javascript" src="javascript/main.js"></script-->
    <script>

function setCookie(usuario,estado){

  var expiracion = new Date();
  expiracion.setDate(expiracion.getDate()+1); //la cookie dura un dia
  document.cookie = usuario + "=" + escape(estado) + "; expires=" +expiracion.toGMTString()+"; path=/";
}

function getCookie(cookie_name) {
  /*
     document.cookie tiene todas las cookies que posee el browser en
     forma de string nombreCookie1=valor1; nombreCookie2=valor2
     */
  var name = cookie_name + "=";
  //handle cookies with special characters
  var decodedCookie = decodeURIComponent(document.cookie);
  var cookie_array = decodedCookie.split(';');
  for(var i = 0; i <cookie_array.length; i++) {
    var c = cookie_array[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length); //retorno valor de cookie
    }
  }
  return ""; //cookie not found
}

function loginUser(){ 
  //check cookie
  var username = document.getElementById('username');
  var cookie = getCookie(username.value);
  if (cookie!=""){
    alert("Bienvenido "+username);
    //alert(document.cookie);
  }else{ 
    alert("No tienes cookie");
  }

}


function logoutUser(){
  var users = document.getElementById('users_div');
  var username = document.getElementById('username');
  setCookie(username.value,'inactivo');

  users.innerHTML = unescape(reqObj.responseText); //lo hace submitHandler??
  users.scrollTop = users.scrollHeight;

  alert('Adios '+username.value);
}

function registrarUser(usrText,targetDiv,users_div,nombre_user){
//function registrarUser(){
  var texto = document.getElementById(usrText);
  var target = document.getElementById(targetDiv);
  var users = document.getElementById(users_div);
  var username = document.getElementById(nombre_user);
  var reqObj = getReqObj();
  setCookie(username.value,'activo');

  var url="cgi-bin/punto5/registrar_user.py?newtxt="+escape(username.value);
  reqObj.open("GET", url, false);
  reqObj.send(null);
  if (reqObj.responseText == "<p>error</p>"){
    alert("Ha ocurrido un error!. Intenta vuevamente");
  }else if (reqObj.responseText == "<p>ya existe</p>"){
    alert("Ya existe el usuario");
  }else{
    alert("Respuesta piolaa!");
    users.innerHTML = unescape(reqObj.responseText); //lo hace submitHandler??
    users.scrollTop = users.scrollHeight;
    submitHandler(texo, target); //PRUEBA -- SINO CON usrText,targetDiv
    //texto.disabled=false; //habilito escritura en chat
    var entorno = setInterval(function(){actualizar()},1000);
  }
}

function actualizarConversacion(){
  var conversacion = document.getElementById('divID');
  var reqObj = getReqObj();
  var url="/cgi-bin/punto_5/actualizar_conversacion";
  reqObj.open("GET", url, false);
  reqObj.send(null);
  conversacion.innerHTML = unescape(reqObj.responseText);
  conversacion.scrollTop = conversacion.scrollHeight;
}

function actualizarUsers(){
  var users = getElementById('users_div');
  var reqObj = getReqObj();
  var url="cgi-bin/punto5/actualizar_users.py";
  reqObj.open("GET", url, false);
  reqObj.send(null);
  users.innerHTML = unescape(reqObj.responseText);//innecesario?
  users.scrollTop = users.scrollHeight;
}

function actualizar(){
  actualizarUsers();
  actualizarConversacion();
}

function getReqObj() {
  var XMLHttpRequestObject;
  if (window.XMLHttpRequest) {
    XMLHttpRequestObject = new XMLHttpRequest();
  } else if (window.ActiveXObject) {
    XMLHttpRequestObject = new ActiveXObject("Microsoft.XMLHTTP");
  }
  return XMLHttpRequestObject;
}

function submitHandler(txtID, divID)
{
  var theText = document.getElementById(txtID);
  var theArea = document.getElementById(divID);
  var reqObj = getReqObj();
  var url="/cgi-bin/punto5/textchat?newtxt=" + escape("<p>" + theText.value + "</p>");
  reqObj.open("GET", url, false);
  reqObj.send(null);
  theArea.innerHTML = unescape(reqObj.responseText);
  theArea.scrollTop = theArea.scrollHeight;
  theText.value = "";
  return false;
}

window.onload=function()
{
  document.forms[0][0].focus();
}

    </script>

  </head>
  <body>
    <h1>Sistemas Distrbuidos</h1>
    <div class="header">
      <div class="navbar">
        <a id="login" onclick="document.getElementById('loginmodal').style.display='block'" style="width:auto;">Login</a>
        <a id="logout" onclick="logoutUser()"> Log Out</a>
        <a id="signup" onclick="document.getElementById('signupmodal').style.display='block'" style="width:auto;">Sign Up</a>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="rightcolumn">
          <h2>Chat Sistemas Distribuidos!</h2>
          <div id="targetDiv"></div>
          <div>
            <form name="forinput" onsubmit="return submitHandler('usrText','targetDiv')">
              <input type="text" placeholder="Ingrese Texto" id="usrText" >
              <!-- habilito cuando el user se loguea-->
            </form>
          </div>
        </div>
        <div class="leftcolumn">
          <h2>Personas</h2>
          <textarea id="users_div" readonly></textarea>
        </div>
      </div>
    </div>
    <div align="center">
      <footer class="footer" id="footer">
        <p> Sistemas Distribuidos  - Aranda Perdomo</p>
      </footer>
    </div>

    <div id="loginmodal" class="modal">
      <div class="modal-content">
        <h1>Login</h1>
        <span onclick="document.getElementById('loginmodal').style.display=
              'none'" class="close" title="Close">&times;</span>
        <form id="loginform" name="loginform" method="post">
          <label for="username">Username:</label>
          <input type="text" name="username" placeholder="Nombre de usuario"
                                             required>
          <input type="submit" name="login-btn" id="login-btn" value="Login"
                                                               onsubmit="loginUser()" align="center">
          <!-- onsubmit="registrarUser('usrText','targetDiv','users_div',
            'username')" align="center"-->
        </form>
      </div>
    </div>

    <div id="signupmodal" class="modal">
      <div class="modal-content">
        <h1>Sign Up</h1>
        <span onclick="document.getElementById('signupmodal').style.display=
              'none'" class="close" title="Close">&times;</span>
        <form id="signupform" name="signupform" method="post">
          <label for="username">Username:</label>
          <input type="text" id="username" placeholder="Nombre de usuario"
                                             required>
          <input type="submit" name="signup-btn" id="signup-btn" value="SignUp" onclick="registrarUser('usrText','targetDiv','users_div', 'username')" align="center">
        </form>
      </div>
    </div>


  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Sistemas Distribuidos</title>
    <link rel="stylesheet" href="css/main.css" type="text/css">
    <script>

function setCookie(usuario,estado){
  //estado in [true, false]
  var expiracion = new Date();
  expiracion.setDate(expiracion.getDate()+1); //la cookie dura un dia
  document.cookie = usuario + "=" + estado + "; expires=" +expiracion.toGMTString()+"; path=/";
}

function getCookie(cookie_name) {
  //document.cookie tiene todas las cookies que posee el browser en
  //forma de string nombreCookie1=valor1; nombreCookie2=valor2
  //Los nombres de las cookies son username y valor booleano
  //ejemplo = "pepe=true; maria=true"
  var name = cookie_name + "=";
  //handle cookies with special characters
  var decodedCookie = decodeURIComponent(document.cookie);
  var cookie_array = decodedCookie.split(';');
  for(var i = 0; i <cookie_array.length; i++) {
    var c = cookie_array[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length); //retorno valor de cookie
    }
  }
  return ""; //cookie not found
}


function logoutUser(){
  var users = document.getElementById('users_div');
  var username = document.getElementById('username');
  users.innerHTML = unescape(reqObj.responseText); //lo hace submitHandler??
  users.scrollTop = users.scrollHeight;
  setCookie(username.value,'false');
}

 
function registrarUser(usrText,targetDiv,users_div){
  var texto = document.getElementById(usrText);
  var target = document.getElementById(targetDiv);
  var users = document.getElementById(users_div);
  var user = document.getElementById('user').value;
  var reqObj = getReqObj();
  var url="/cgi-bin/punto5/registrar_user.py?newtxt="+escape(user);
  reqObj.open("GET", url, false);
  reqObj.send(null);
  if ((reqObj.responseText) == ("<p>error</p>"))
  {
    alert("Ya existe el usuario");
  }else{ 
    //alert("Hola "+user+"!!");
    document.getElementById('username').value = user; //set label
    setCookie(user,'true'); 
    alert("Hola "+document.getElementById('username').value+"!!");
    users.innerHTML = unescape(reqObj.responseText); //lo hace submitHandler??
    users.scrollTop = users.scrollHeight;
    submitHandler(usrText, targetDiv);
    texto.disabled=false; //habilito escritura en chat
    //var entorno = setInterval(function(){actualizar()},1000);
  }
}

function getReqObj() {
  var XMLHttpRequestObject;
  if (window.XMLHttpRequest) {
    XMLHttpRequestObject = new XMLHttpRequest();
  } else if (window.ActiveXObject) {
    XMLHttpRequestObject = new ActiveXObject("Microsoft.XMLHTTP");
  }
  return XMLHttpRequestObject;
}

function submitHandler(txtID, divID)
{
  var theText = document.getElementById(txtID);
  var theArea = document.getElementById(divID);
  var username = document.getElementById('username');
  var reqObj = getReqObj();
  if (username.value!=""){ 
    var url="/cgi-bin/punto5/textchat?newtxt=" + escape("<p>" + username.value +":"+ theText.value + "</p>");
  }else{
    var url="/cgi-bin/punto5/textchat?newtxt=" + escape("<p>" + theText.value + "</p>");

  }
  reqObj.open("GET", url, false);
  reqObj.send(null);
  theArea.innerHTML = unescape(reqObj.responseText);
  theArea.scrollTop = theArea.scrollHeight;
  theText.value = "";
  return false;
}

window.onload=function()
{
  document.forms[0][0].focus();
}

    </script>

  </head>
  <body>
    <h1>Sistemas Distrbuidos</h1>

    <div id="signupmodal" class="modal">
      <div class="modal-content">
        <h1>Sign Up</h1>
        <span onclick="document.getElementById('signupmodal').style.display=
              'none'" class="close" title="Close">&times;</span>
        <form id="signupform" name="signupform" method="post">
          <label>Username:</label>
          <input type="text" id="user" placeholder="Nombre de usuario"
                                             required>
          <input type="submit" name="signup-btn" id="signup-btn" value="SignUp" onclick="registrarUser('usrText','targetDiv','users_div')" align="center">
        </form>
      </div>
    </div>

    <div class="header">
      <div class="navbar">
        <a id="signup" onclick="document.getElementById('signupmodal').style.display='block'" style="width:auto;">Sign Up</a>
        <a id="logout" onclick="logoutUser('username')"> Log Out</a>
        <input id="username" value="" disabled />
      </div>
    </div>



    <div class="container">
      <div class="row">
        <div class="rightcolumn">
          <h2>Chat Sistemas Distribuidos!</h2>
          <div id="targetDiv"></div>
          <div>
            <form name="forinput" onsubmit="return submitHandler('usrText','targetDiv')">
              <input type="text" placeholder="Ingrese Texto" id="usrText" >
            </form>
          </div>
        </div>
        <div class="leftcolumn">
          <h2>Personas</h2>
          <textarea id="users_div" readonly></textarea>
        </div>
      </div>
    </div>
    <div align="center">
      <footer class="footer" id="footer">
        <p> Sistemas Distribuidos  - Aranda Perdomo</p>
      </footer>
    </div>


  

  </body>
</html>
